function [H, HI, D1, D2, M, Q, e_1, e_m, S_1, S_m, x, h] = d2_noneq_6(N,L,narrowing)
% N: Number of grid points
% L: Domain length
% narrowing: Width of internal stencil in D2
%            0 - wide
%            1 - two additional stencil points (one on each side) compared
%            to minimally narrow
%            2 - minimally narrow 

% BP: Number of boundary points
% m:  Number of nonequidistant spacings
% order: Accuracy of interior stencil
BP = 6;
m = 3;
order = 6;

e_1=sparse(N,1);e_1(1)=1;
e_m=sparse(N,1);e_m(N)=1;

%%%% Non-equidistant grid points %%%%%
x0 =  0.0000000000000e+00;
x1 =  4.4090263368623e-01;
x2 =  1.2855984345073e+00;
x3 =  2.2638953951239e+00;
x4 =  3.2638953951239e+00;
x5 =  4.2638953951239e+00;
x6 =  5.2638953951239e+00;

xb = sparse(m+1,1);
for i = 0:m
    xb(i+1) = eval(['x' num2str(i)]);
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%% Compute h %%%%%%%%%%
h = L/(2*xb(end) + N-1-2*m);
%%%%%%%%%%%%%%%%%%%%%%%%%

%%%% Define grid %%%%%%%%
x = h*[xb; linspace(xb(end)+1,L/h-xb(end)-1,N-2*(m+1))'; L/h-flip(xb) ];
%%%%%%%%%%%%%%%%%%%%%%%%%

%%%% Norm matrix %%%%%%%%
P = sparse(BP,1);
P0 =  1.3030223027124e-01;
P1 =  6.8851501587715e-01;
P2 =  9.5166202564389e-01;
P3 =  9.9103890475697e-01;
P4 =  1.0028757074552e+00;
P5 =  9.9950151111941e-01;

for i = 0:BP-1
    P(i+1) = eval(['P' num2str(i)]);
end

H = ones(N,1);
H(1:BP) = P;
H(end-BP+1:end) = flip(P);
H = spdiags(h*H,0,N,N);
HI = inv(H);
%%%%%%%%%%%%%%%%%%%%%%%%%

%%%% Q matrix %%%%%%%%%%%
% interior stencil
switch order
    case 2
        d = [-1/2,0,1/2];
    case 4
        d = [1/12,-2/3,0,2/3,-1/12];
    case 6
        d = [-1/60,3/20,-3/4,0,3/4,-3/20,1/60];
    case 8
        d = [1/280,-4/105,1/5,-4/5,0,4/5,-1/5,4/105,-1/280];
    case 10
        d = [-1/1260,5/504,-5/84,5/21,-5/6,0,5/6,-5/21,5/84,-5/504,1/1260];
    case 12
        d = [1/5544,-1/385,1/56,-5/63,15/56,-6/7,0,6/7,-15/56,5/63,-1/56,1/385,-1/5544];
end
d = repmat(d,N,1);
Q = spdiags(d,-order/2:order/2,N,N);

% Boundaries
Q0_0 = -5.0000000000000e-01;
Q0_1 =  6.6042071945824e-01;
Q0_2 = -2.2104152954203e-01;
Q0_3 =  7.6243679810093e-02;
Q0_4 = -1.7298206716724e-02;
Q0_5 =  1.6753369904210e-03;
Q0_6 =  0.0000000000000e+00;
Q0_7 =  0.0000000000000e+00;
Q0_8 =  0.0000000000000e+00;
Q1_0 = -6.6042071945824e-01;
Q1_1 =  0.0000000000000e+00;
Q1_2 =  8.7352798702787e-01;
Q1_3 = -2.6581719253084e-01;
Q1_4 =  5.7458484948314e-02;
Q1_5 = -4.7485599871040e-03;
Q1_6 =  0.0000000000000e+00;
Q1_7 =  0.0000000000000e+00;
Q1_8 =  0.0000000000000e+00;
Q2_0 =  2.2104152954203e-01;
Q2_1 = -8.7352798702787e-01;
Q2_2 =  0.0000000000000e+00;
Q2_3 =  8.1707122038457e-01;
Q2_4 = -1.8881125503769e-01;
Q2_5 =  2.4226492138960e-02;
Q2_6 =  0.0000000000000e+00;
Q2_7 =  0.0000000000000e+00;
Q2_8 =  0.0000000000000e+00;
Q3_0 = -7.6243679810093e-02;
Q3_1 =  2.6581719253084e-01;
Q3_2 = -8.1707122038457e-01;
Q3_3 =  0.0000000000000e+00;
Q3_4 =  7.6798636652679e-01;
Q3_5 = -1.5715532552963e-01;
Q3_6 =  1.6666666666667e-02;
Q3_7 =  0.0000000000000e+00;
Q3_8 =  0.0000000000000e+00;
Q4_0 =  1.7298206716724e-02;
Q4_1 = -5.7458484948314e-02;
Q4_2 =  1.8881125503769e-01;
Q4_3 = -7.6798636652679e-01;
Q4_4 =  0.0000000000000e+00;
Q4_5 =  7.5266872305402e-01;
Q4_6 = -1.5000000000000e-01;
Q4_7 =  1.6666666666667e-02;
Q4_8 =  0.0000000000000e+00;
Q5_0 = -1.6753369904210e-03;
Q5_1 =  4.7485599871040e-03;
Q5_2 = -2.4226492138960e-02;
Q5_3 =  1.5715532552963e-01;
Q5_4 = -7.5266872305402e-01;
Q5_5 =  0.0000000000000e+00;
Q5_6 =  7.5000000000000e-01;
Q5_7 = -1.5000000000000e-01;
Q5_8 =  1.6666666666667e-02;
for i = 1:BP
    for j = 1:BP
        Q(i,j) = eval(['Q' num2str(i-1) '_' num2str(j-1)]);
        Q(N+1-i,N+1-j) = -eval(['Q' num2str(i-1) '_' num2str(j-1)]);
    end
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%% Difference operator D1 %%
D1 = H\Q;

%%%%%%%%%%%%%%%%%%%%%%%%%%%
DD_4=(diag(ones(N-2,1),2)-4*diag(ones(N-1,1),1)+6*diag(ones(N,1),0)-4*diag(ones(N-1,1),-1)+diag(ones(N-2,1),-2));
DD_4(1:5,1:7)=[0 0 0 0 0 0 0; 0 0 0 0 0 0 0; 0.57302111593550648941e1 -0.12521994384708052700e2 0.11419402572582197931e2 -0.59442797107089754133e1 0.13166603634797652881e1 0 0; 0 0.14441513881249918393e1 -0.49292485821432017638e1 0.67286137322011497757e1 -0.42974416973037268190e1 0.10539251591207869677e1 0; 0 0 0.10466075357769140419e1 -0.40887380427708663837e1 0.60658234020943532065e1 -0.40291482544157815088e1 0.10054553593153806442e1;];
DD_4(N-4:N,N-6:N)=[0.10054553593153806442e1 -0.40291482544157815088e1 0.60658234020943532065e1 -0.40887380427708663837e1 0.10466075357769140419e1 0 0; 0 0.10539251591207869677e1 -0.42974416973037268190e1 0.67286137322011497757e1 -0.49292485821432017638e1 0.14441513881249918393e1 0; 0 0 0.13166603634797652881e1 -0.59442797107089754133e1 0.11419402572582197931e2 -0.12521994384708052700e2 0.57302111593550648941e1; 0 0 0 0 0 0 0; 0 0 0 0 0 0 0;];
DD_4=sparse(DD_4);

DD_5=(-diag(ones(N-3,1),-3)+5*diag(ones(N-2,1),-2)-10*diag(ones(N-1,1),-1)+10*diag(ones(N,1),0)-5*diag(ones(N-1,1),1)+diag(ones(N-2,1),2));
DD_5(1:6,1:8)=[0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0; -0.67194556014531368457e1 0.16377214352871472626e2 -0.19171027475746103125e2 0.14860699276772438533e2 -0.65833018173988264407e1 0.12358712649541552519e1 0 0; 0 -0.14971527633959360324e1 0.61951742553920293904e1 -0.11214356220335249626e2 0.10743604243259317047e2 -0.52696257956039348385e1 0.10423562806837740594e1 0; 0 0 -0.10511702536596915242e1 0.51109225534635829797e1 -0.10109705670157255344e2 0.10072870636039453772e2 -0.50272767965769032212e1 0.10043595308908133377e1;];
DD_5(N-4:N,N-7:N)=[-0.10043595308908133377e1 0.50272767965769032212e1 -0.10072870636039453772e2 0.10109705670157255344e2 -0.51109225534635829797e1 0.10511702536596915242e1 0 0; 0 -0.10423562806837740594e1 0.52696257956039348385e1 -0.10743604243259317047e2 0.11214356220335249626e2 -0.61951742553920293904e1 0.14971527633959360324e1 0; 0 0 -0.12358712649541552519e1 0.65833018173988264407e1 -0.14860699276772438533e2 0.19171027475746103125e2 -0.16377214352871472626e2 0.67194556014531368457e1; 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0;];
DD_5=sparse(DD_5);

DD_6=(diag(ones(N-3,1),3)-6*diag(ones(N-2,1),2)+15*diag(ones(N-1,1),1)-20*diag(ones(N,1),0)+15*diag(ones(N-1,1),-1)-6*diag(ones(N-2,1),-2)+diag(ones(N-3,1),-3));
DD_6(1:6,1:9)=[0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 0; 0.76591061528436941127e1 -0.20373923615000091397e2 0.28913418478606999359e2 -0.29721398553544877066e2 0.19749905452196479322e2 -0.74152275897249315116e1 0.11881196746227271813e1 0 0; 0 0.15426631885693469226e1 -0.74666187707188589528e1 0.16821534330502874439e2 -0.21487208486518634095e2 0.15808877386811804515e2 -0.62541376841026443562e1 0.10348900354561115264e1 0; 0 0 0.10549863219420430611e1 -0.61331070641562995756e1 0.15164558505235883016e2 -0.20145741272078907544e2 0.15081830389730709664e2 -0.60261571853448800265e1 0.10036303046714514054e1;];
DD_6(N-5:N,N-8:N)=[0.10036303046714514054e1 -0.60261571853448800265e1 0.15081830389730709664e2 -0.20145741272078907544e2 0.15164558505235883016e2 -0.61331070641562995756e1 0.10549863219420430611e1 0 0; 0 0.10348900354561115264e1 -0.62541376841026443562e1 0.15808877386811804515e2 -0.21487208486518634095e2 0.16821534330502874439e2 -0.74666187707188589528e1 0.15426631885693469226e1 0; 0 0 0.11881196746227271813e1 -0.74152275897249315116e1 0.19749905452196479322e2 -0.29721398553544877066e2 0.28913418478606999359e2 -0.20373923615000091397e2 0.76591061528436941127e1; 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 0;];
DD_6=sparse(DD_6);

R1 = transpose(DD_5)*DD_5*(1/600/h) + transpose(DD_6)*DD_6*(1/3600/h);
R2 = transpose(DD_4)*DD_4*(1/80/h) + transpose(DD_5)*DD_5*(1/600/h) + transpose(DD_6)*DD_6*(1/3600/h);

%%%%%%%%%%%%%%%%%%%%%%%
S_1 = e_1'*D1;
S_m = e_m'*D1;
BS =  -e_1*S_1 + e_m*S_m;

S_1 = S_1';
S_m = S_m';

switch narrowing
    case 0
        M = D1'*H*D1;
    case 1
        M = D1'*H*D1 + R1;
    case 2
        M = D1'*H*D1 + R2;
    otherwise
        error('Narrowing option not implemented. Available options: 0, 1, 2.');
end

%%%% Difference operator D2 %%
D2 = H\(-M + BS);